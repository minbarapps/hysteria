#!/bin/bash

# Database info
DB_HOST='136.243.103.110'
DB_USER='viptunnelvpn_ownT'
DB_NAME='viptunnelvpn_ownT'
DB_PASSWORD='dx8qLn2WOqz7'

# Update package lists
apt-get update

# Install OpenVPN and MySQL client
apt-get install -y openvpn mariadb-client iptables openssl ca-certificates

# Change ownership and permissions for necessary files and directories
chown root:root /etc/openvpn/server.key /etc/openvpn/server.crt /etc/openvpn/server.conf /etc/openvpn/ta.key /etc/openvpn/dh.pem
chmod 600 /etc/openvpn/server.key /etc/openvpn/server.crt /etc/openvpn/ta.key /etc/openvpn/dh.pem

# Generate server certificates and keys
openssl genpkey -algorithm RSA -out /etc/openvpn/server.key 2048
openssl req -new -key /etc/openvpn/server.key -out /etc/openvpn/server.csr -subj "/C=US/ST=CA/L=City/O=Organization/CN=OpenVPN"
openssl x509 -req -days 3650 -in /etc/openvpn/server.csr -signkey /etc/openvpn/server.key -out /etc/openvpn/server.crt
openssl dhparam -out /etc/openvpn/dh.pem 2048
openvpn --genkey --secret /etc/openvpn/ta.key

# Get easy-rsa
EASYRSAURL='https://github.com/OpenVPN/easy-rsa/releases/download/v3.0.5/EasyRSA-nix-3.0.5.tgz'
wget -O ~/easyrsa.tgz "$EASYRSAURL" 2>/dev/null || curl -Lo ~/easyrsa.tgz "$EASYRSAURL"
tar xzf ~/easyrsa.tgz -C ~/
mv ~/EasyRSA-3.0.5/ /etc/openvpn/server/
mv /etc/openvpn/server/EasyRSA-3.0.5/ /etc/openvpn/server/easy-rsa/
chown -R root:root /etc/openvpn/server/easy-rsa/
rm -f ~/easyrsa.tgz
cd /etc/openvpn/server/easy-rsa/

# Create the PKI, set up the CA and the server and client certificates
./easyrsa init-pki
./easyrsa --batch build-ca nopass
EASYRSA_CERT_EXPIRE=3650 ./easyrsa build-server-full server nopass
EASYRSA_CERT_EXPIRE=3650 ./easyrsa build-client-full client nopass
EASYRSA_CRL_DAYS=3650 ./easyrsa gen-crl

# Move the stuff we need
cp pki/ca.crt pki/private/ca.key pki/issued/server.crt pki/private/server.key pki/crl.pem /etc/openvpn/server/
# CRL is read with each client connection, when OpenVPN is dropped to nobody
chown nobody:nogroup /etc/openvpn/server/crl.pem

# Generate key for tls-auth
openvpn --genkey --secret /etc/openvpn/server/ta.key





# Get the VPS IP address
VPS_IP=$(curl -s https://api.ipify.org)

# Update OpenVPN server configuration with correct paths
cat > /etc/openvpn/server.conf <<EOL
port 1194
proto tcp
dev tun
server 10.8.0.0 255.255.255.0
push "dhcp-option DNS 8.8.8.8"
push "dhcp-option DNS 8.8.4.4"
duplicate-cn
key /etc/openvpn/server.key
cert /etc/openvpn/server.crt
dh /etc/openvpn/dh.pem
auth SHA256
cipher AES-256-CBC
tls-server
tls-auth /etc/openvpn/ta.key 0
comp-lzo
user nobody
group nogroup
persist-key
persist-tun
status /var/log/openvpn-status.log
log /var/log/openvpn.log
verb 3
EOL

# Enable IP forwarding
echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf
sysctl -p

# Configure iptables to allow VPN traffic
iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE
iptables-save > /etc/iptables.rules

# Enable OpenVPN service
systemctl enable openvpn
systemctl start openvpn

# Function to update online count in the database
update_online_count() {
  mysql -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASSWORD" "$DB_NAME" -e "UPDATE server_list SET online = online $1 WHERE server_ip = '$VPS_IP';"
}

# Event triggered when a client connects
echo "client-connect /etc/openvpn/client-connect.sh" >> /etc/openvpn/server.conf

# Event triggered when a client disconnects
echo "client-disconnect /etc/openvpn/client-disconnect.sh" >> /etc/openvpn/server.conf

# Script to run when a client connects
cat > /etc/openvpn/client-connect.sh <<EOL
#!/bin/bash
source /etc/openvpn/update-online-count.sh
update_online_count="+ 1"
update_online_count
EOL
chmod +x /etc/openvpn/client-connect.sh

# Script to run when a client disconnects
cat > /etc/openvpn/client-disconnect.sh <<EOL
#!/bin/bash
source /etc/openvpn/update-online-count.sh
update_online_count="- 1"
update_online_count
EOL
chmod +x /etc/openvpn/client-disconnect.sh

# Script to update online count
cat > /etc/openvpn/update-online-count.sh <<EOL
#!/bin/bash
source /etc/openvpn/database-credentials.sh
mysql -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASSWORD" "$DB_NAME" -e "UPDATE server_list SET online = online $update_online_count WHERE server_ip = '$VPS_IP';"
EOL
chmod +x /etc/openvpn/update-online-count.sh

# Create OpenVPN client configuration file
cat > /etc/openvpn/client.conf <<EOL
client
dev tun
proto tcp
remote $VPS_IP 1194
nobind
key-direction 1
client-key-direction 1
cipher AES-256-CBC
auth SHA256
persist-key
persist-tun
comp-lzo
verb 3
<ca>
$(cat /etc/openvpn/server/easy-rsa/pki/ca.crt)
</ca>
<cert>
$(cat /etc/openvpn/server/easy-rsa/pki/issued/$1.crt)
</cert>
<key>
$(cat /etc/openvpn/server/easy-rsa/pki/private/$1.key)
</key>
<tls-auth>
$(cat /etc/openvpn/server/ta.key)
</tls-auth>
EOL

# Update the OpenVPN config in the database
mysql -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASSWORD" "$DB_NAME" -e "UPDATE server_list SET config = '$(cat /etc/openvpn/client.conf)', status = 1 WHERE server_ip = '$VPS_IP';"

echo "OpenVPN has been installed, configured, and database updated successfully."
